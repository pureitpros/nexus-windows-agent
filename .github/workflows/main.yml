name: Build NEXUS Agent

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1
      
    - name: Restore NuGet packages
      run: nuget restore NexusAgent.csproj -PackagesDirectory packages
    
    - name: Build
      run: msbuild NexusAgent.csproj /p:Configuration=Release /p:Platform="Any CPU" /p:OutputPath=bin\Release\
      
    - name: Create template.exe with placeholder
      shell: powershell
      run: |
        $exePath = "bin\Release\NexusAgent.exe"
        if (!(Test-Path $exePath)) {
          Write-Error "Build output not found at: $exePath"
          Get-ChildItem -Recurse -Filter "*.exe" | ForEach-Object { Write-Host $_.FullName }
          exit 1
        }
        
        # Read the compiled executable
        $exeBytes = [System.IO.File]::ReadAllBytes($exePath)
        
        # Create placeholder (500 bytes padded with spaces)
        $placeholder = "<<<NEXUS_CREDENTIALS_PLACEHOLDER>>>"
        $paddedPlaceholder = $placeholder.PadRight(500, ' ')
        $placeholderBytes = [System.Text.Encoding]::UTF8.GetBytes($paddedPlaceholder)
        
        # Append placeholder to the end of the executable
        $templateBytes = $exeBytes + $placeholderBytes
        
        # Write template.exe
        $templatePath = "bin\Release\template.exe"
        [System.IO.File]::WriteAllBytes($templatePath, $templateBytes)
        
        Write-Host "Created template.exe ($(([System.IO.FileInfo]$templatePath).Length) bytes)"
        Write-Host "Placeholder appended at offset: $($exeBytes.Length)"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: nexus-agent-template
        path: bin\Release\template.exe
