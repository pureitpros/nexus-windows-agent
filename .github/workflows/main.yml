name: Build NEXUS Agent

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Restore NuGet packages
      run: nuget restore NexusAgent.csproj -PackagesDirectory packages

    - name: Build
      run: msbuild NexusAgent.csproj /p:Configuration=Release /p:Platform="Any CPU" /p:OutputPath=bin\Release\

    - name: Create template with placeholder
      shell: pwsh
      run: |
        $exePath = "bin\Release\NexusAgent.exe"
        
        # Create the placeholder string (must match what edge function looks for)
        $placeholder = "<<<NEXUS_CREDENTIALS_PLACEHOLDER>>>"
        
        # Pad to 500 bytes for credential space
        $paddedPlaceholder = $placeholder.PadRight(500, ' ')
        $placeholderBytes = [System.Text.Encoding]::UTF8.GetBytes($paddedPlaceholder)
        
        # Read existing file bytes
        $existingBytes = [System.IO.File]::ReadAllBytes($exePath)
        
        # Combine bytes
        $combinedBytes = New-Object byte[] ($existingBytes.Length + $placeholderBytes.Length)
        [System.Array]::Copy($existingBytes, 0, $combinedBytes, 0, $existingBytes.Length)
        [System.Array]::Copy($placeholderBytes, 0, $combinedBytes, $existingBytes.Length, $placeholderBytes.Length)
        
        # Write combined bytes
        [System.IO.File]::WriteAllBytes($exePath, $combinedBytes)
        
        # Rename to template.exe
        Rename-Item $exePath "template.exe"
        
        Write-Host "Template created successfully with $(($combinedBytes).Length) bytes"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: nexus-agent-template
        path: bin\Release\template.exe
