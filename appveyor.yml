version: 1.0.{build}
image: Visual Studio 2022

before_build:
  - dotnet restore

build_script:
  - dotnet build -c Release

after_build:
  - ps: |
      $exePath = "bin\Release\net48\NexusAgent.exe"
      if (Test-Path $exePath) {
        $placeholder = "<<<NEXUS_CREDENTIALS_PLACEHOLDER>>>"
        $padding = " " * (500 - $placeholder.Length)
        $placeholderPadded = $placeholder + $padding
        
        $bytes = [System.IO.File]::ReadAllBytes($exePath)
        $placeholderBytes = [System.Text.Encoding]::UTF8.GetBytes($placeholderPadded)
        $newBytes = $bytes + $placeholderBytes
        [System.IO.File]::WriteAllBytes("template.exe", $newBytes)
        Write-Host "Created template.exe with embedded placeholder"
      } else {
        Write-Host "ERROR: $exePath not found"
        Get-ChildItem -Recurse -Filter "*.exe" | ForEach-Object { Write-Host $_.FullName }
        exit 1
      }

artifacts:
  - path: template.exe
    name: NEXUS-Agent-Template
